<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' tauri: asset: file: data: blob: filesystem:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval' 'unsafe-inline'">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Always On Top</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; background: #111; color: #ccc; }
      #app { height: 100%; width: 100%; position: relative; }
      .image-container { height: 100%; width: 100%; display: grid; place-items: center; background: #111; }
      .image-container img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
      .image-container.placeholder img { display: none; }
      .image-container:not(.placeholder) img { display: block; }
      .image-container:not(.placeholder) .placeholder-text { display: none; }
      .placeholder-text { color: #888; font-size: 14px; text-align: center; padding: 12px; }
      .hud { position: absolute; top: 8px; left: 8px; right: 8px; display: flex; justify-content: space-between; align-items: center; gap: 8px; pointer-events: none; }
      .hud .info { background: rgba(0,0,0,0.55); padding: 6px 10px; border-radius: 8px; font-size: 13px; color: #eee; max-width: 70%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
      .controls { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; }
      .btn { pointer-events: auto; background: rgba(255,255,255,0.08); color: #eee; border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; padding: 8px 12px; font-size: 13px; cursor: pointer; }
      .btn:disabled { opacity: 0.4; cursor: not-allowed; }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="hud">
        <div class="info" id="fileInfo">No file selected</div>
        <div class="info" id="status"></div>
      </div>
      <div id="imageContainer" class="image-container placeholder">
        <img id="image" alt="Selected file preview" />
        <div id="placeholder" class="placeholder-text">No file selected</div>
      </div>
      <div class="controls">
        <button id="prevBtn" class="btn" type="button">Previous</button>
        <button id="nextBtn" class="btn" type="button">Next</button>
      </div>
    </div>
    <script>
      const tauri = window.__TAURI__ || {};
      const invoke = (cmd, args) => {
        if (tauri?.core?.invoke) return tauri.core.invoke(cmd, args); // Tauri v2 global API
        if (tauri.invoke) return tauri.invoke(cmd, args); // fallback for older globals
        return Promise.resolve();
      };
      const convertFileSrc = tauri?.core?.convertFileSrc || tauri.convertFileSrc;
      const imageContainer = document.getElementById('imageContainer');
      const imageEl = document.getElementById('image');
      const placeholderEl = document.getElementById('placeholder');
      const fileInfoEl = document.getElementById('fileInfo');
      const statusEl = document.getElementById('status');
      const prevBtn = document.getElementById('prevBtn');
      const nextBtn = document.getElementById('nextBtn');

      const showPlaceholder = (message = 'No file selected') => {
        imageContainer.classList.add('placeholder');
        placeholderEl.textContent = message;
        imageEl.src = '';
        fileInfoEl.textContent = message;
        statusEl.textContent = '';
        prevBtn.disabled = true;
        nextBtn.disabled = true;
      };

      const buildSources = (path) => {
        const sources = [];
        if (!path) return sources;
        if (convertFileSrc) {
          try {
            sources.push(convertFileSrc(path));
          } catch (_) {
            // Ignore and continue to file:// fallback
          }
        }
        const encodedPath = encodeURI(path.startsWith('/') ? path : `/${path}`);
        const fileSrc = path.startsWith('file://') ? path : `file://${encodedPath}`;
        sources.push(fileSrc);
        return sources;
      };

      const trySource = (src) =>
        new Promise((resolve) => {
          const cleanup = () => {
            imageEl.onload = null;
            imageEl.onerror = null;
          };
          imageEl.onload = () => {
            cleanup();
            imageContainer.classList.remove('placeholder');
            placeholderEl.textContent = '';
            resolve(true);
          };
          imageEl.onerror = () => {
            cleanup();
            resolve(false);
          };
          imageEl.src = src;
        });

      const showImage = async (path) => {
        if (!path) {
          showPlaceholder();
          return;
        }
        const sources = buildSources(path);
        for (let i = 0; i < sources.length; i += 1) {
          // eslint-disable-next-line no-await-in-loop
          const ok = await trySource(sources[i]);
          if (ok) return;
        }
        try {
          const dataUrl = await invoke('load_image_data', { path });
          const ok = await trySource(dataUrl);
          if (ok) return;
        } catch (err) {
          console.warn('Image fallback failed', err);
        }
        showPlaceholder('Image unavailable');
      };

      const renderState = (payload) => {
        const path = payload?.path;
        const index = payload?.index ?? null;
        const total = payload?.total ?? null;
        if (!path) {
            showPlaceholder();
            return;
        }
        const fileName = path.split(/[\\/]/).pop() || path;
        fileInfoEl.textContent = fileName;
        if (typeof index === 'number' && typeof total === 'number' && total > 0) {
          statusEl.textContent = `File ${index + 1} of ${total}`;
          prevBtn.disabled = index <= 0;
          nextBtn.disabled = index >= total - 1;
        } else {
          statusEl.textContent = '';
          prevBtn.disabled = false;
          nextBtn.disabled = false;
        }
        showImage(path);
      };

      const bootstrap = async () => {
        try {
          const settings = await invoke('get_settings');
          if (settings?.last_file) {
            renderState({ path: settings.last_file });
            return;
          }
        } catch (err) {
          console.warn('Failed to load settings', err);
        }
        showPlaceholder();
      };

      bootstrap();

      const registerListeners = () => {
        if (tauri?.event?.listen) {
          tauri.event
            .listen('active-file-changed', async (event) => {
              renderState(event?.payload);
            })
            .catch((err) => console.warn('Failed to register active-file listener', err));
          tauri.event
            .listen('file-selected', async (event) => {
              // Backward compatibility fallback
              const payload = event?.payload;
              if (payload?.path || typeof payload === 'string') {
                renderState({ path: payload.path || payload });
              }
            })
            .catch((err) => console.warn('Failed to register file-selected listener', err));
        } else {
          console.warn('Tauri event API unavailable; UI will not live-update on selection.');
        }
      };

      registerListeners();

      prevBtn.addEventListener('click', () => invoke('previous_file'));
      nextBtn.addEventListener('click', () => invoke('next_file'));
    </script>
  </body>
</html>
