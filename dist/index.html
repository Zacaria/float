<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src 'self' tauri: asset: file: data: blob: filesystem:; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-eval' 'unsafe-inline'">
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Always On Top</title>
    <style>
      html, body { height: 100%; margin: 0; font-family: -apple-system, system-ui, Segoe UI, Roboto, Arial, sans-serif; background: #111; color: #ccc; }
      #app { height: 100%; width: 100%; }
      .image-container { height: 100%; width: 100%; display: grid; place-items: center; background: #111; }
      .image-container img { max-width: 100%; max-height: 100%; object-fit: contain; display: none; }
      .image-container.placeholder img { display: none; }
      .image-container:not(.placeholder) img { display: block; }
      .image-container:not(.placeholder) .placeholder-text { display: none; }
      .placeholder-text { color: #888; font-size: 14px; text-align: center; padding: 12px; }
    </style>
  </head>
  <body>
    <div id="app">
      <div id="imageContainer" class="image-container placeholder">
        <img id="image" alt="Selected file preview" />
        <div id="placeholder" class="placeholder-text">No file selected</div>
      </div>
    </div>
    <script>
      const tauri = window.__TAURI__ || {};
      const invoke = (cmd, args) => {
        if (tauri?.core?.invoke) return tauri.core.invoke(cmd, args); // Tauri v2 global API
        if (tauri.invoke) return tauri.invoke(cmd, args); // fallback for older globals
        return Promise.resolve();
      };
      const convertFileSrc = tauri?.core?.convertFileSrc || tauri.convertFileSrc;
      const imageContainer = document.getElementById('imageContainer');
      const imageEl = document.getElementById('image');
      const placeholderEl = document.getElementById('placeholder');

      const showPlaceholder = (message = 'No file selected') => {
        imageContainer.classList.add('placeholder');
        placeholderEl.textContent = message;
        imageEl.src = '';
      };

      const buildSources = (path) => {
        const sources = [];
        if (!path) return sources;
        if (convertFileSrc) {
          try {
            const assetSrc = convertFileSrc(path);
            console.debug('convertFileSrc resolved', { path, assetSrc });
            sources.push(assetSrc);
          } catch (err) {
            console.warn('convertFileSrc failed, will try other fallbacks', { path, err });
          }
        }
        const encodedPath = encodeURI(path.startsWith('/') ? path : `/${path}`);
        const manualAsset = `asset://localhost${encodedPath}`;
        sources.push(manualAsset);
        const fileSrc = path.startsWith('file://') ? path : `file://${encodedPath}`;
        sources.push(fileSrc);
        return sources;
      };

      const trySource = (path, src, index) =>
        new Promise((resolve) => {
          imageEl.onload = () => {
            imageContainer.classList.remove('placeholder');
            placeholderEl.textContent = '';
            resolve(true);
          };
          imageEl.onerror = () => {
            console.warn('Image load failed', { path, src, index });
            resolve(false);
          };
          imageEl.src = src;
        });

      const showImage = async (path) => {
        if (!path) {
          showPlaceholder();
          return;
        }
        const sources = buildSources(path);
        for (let i = 0; i < sources.length; i += 1) {
          const ok = await trySource(path, sources[i], i);
          if (ok) return;
        }
        try {
          const dataUrl = await invoke('load_image_data', { path });
          const ok = await trySource(path, dataUrl, sources.length);
          if (ok) return;
        } catch (err) {
          console.warn('load_image_data failed', { path, err });
        }
        showPlaceholder('Image unavailable');
      };

      const bootstrap = async () => {
        try {
          const settings = await invoke('get_settings');
          if (settings?.last_file) {
            await showImage(settings.last_file);
          } else {
            showPlaceholder();
          }
        } catch (_) {
          showPlaceholder();
        }
      };

      bootstrap();

      if (tauri?.event?.listen) {
        tauri.event
          .listen('file-selected', async (event) => {
            const path = event?.payload?.path ?? event?.payload ?? null;
            console.debug('file-selected event', { path });
            if (path) {
              await showImage(path);
            } else {
              showPlaceholder();
            }
          })
          .catch((err) => console.warn('Failed to register file-selected listener', err));
      } else {
        console.warn('Tauri event API unavailable; UI will not live-update on selection.');
      }
    </script>
  </body>
  </html>
